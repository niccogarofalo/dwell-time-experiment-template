<!DOCTYPE html>
    <html>
        <head>
            <!-- Global site tag (gtag.js) - Google Analytics -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141293639-1"></script>
            <script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
            
              gtag('config', 'UA-141293639-1');
            </script>

            <title>Dwell-time experiment</title>

            <meta name="keyword" content="CRAN R, R, MRAN, Psychology Experiment, Psychology, Experiment, statistics, regression, stats, analysis, analyses, javascript, js, yasuhere">

            <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <script src="jspsych-6/jspsych.js"></script>
            <script src="jspsych-6/plugins/jspsych-html-keyboard-response.js"></script>
            <script src="jspsych-6/plugins/jspsych-image-keyboard-response.js"></script>
            <script src="jspsych-6/plugins/jspsych-audio-keyboard-response.js"></script>
            <script src="jspsych-6/plugins/jspsych-video-keyboard-response.js"></script>
            <script src="jspsych-6/plugins/jspsych-resize.js" type="text/javascript"></script>
            <link  href="jspsych-6/css/jspsych.css" rel="stylesheet" type="text/css"></link>
            <script type="text/javascript" src="lib/vendors/jquery-2.2.0.min.js"></script>
            <script type="text/javascript" src="lib/jspsych-pavlovia-3.0.0.js"></script>
            <script type="text/javascript" src="./sheetjs-0.16.8/dist/xlsx.full.min.js"></script>
            <script type="text/javascript" src="./settings.js"></script>
            <script type="text/javascript" src="./slideshowparser.js"></script>
        </head>
        <body>
    <script>

        /* create array timeline */
        var timeline = [];

        // randomly generate a session ID for the participant and add it to the trial data
        var sessionId = makeParticipantId(length_of_participant_id);
        jsPsych.data.addProperties({
            session_id: sessionId,
        })
        
        /* init connection with pavlovia.org */
        var pavlovia_init = {
	        type: "pavlovia",
	        command: "init"
        };
        timeline.push(pavlovia_init);

        // Add introductory slides for things declared in settings.js
        for (let i = 0; i < study_introduction.length; i ++) {
            timeline.push(parseJavaScriptData(study_introduction[i]));
        }
        
        /* test trial */
        /*
var test_stimuli = [
{ stimulus: "sample_image/1_bro1854.jpg" },
{ stimulus: "sample_image/1_bro1856.jpg" },
...
{ stimulus: "sample_image/9_mil2434.jpg" },
{ stimulus: "sample_image/9_mil2436.jpg" },
];
        /* preload images manually 
        var images = ["sample_image/sample video 02.jpg",
                      "sample_image/sample video 03.jpg",
                      ...
                      "sample_image/sample video 36.jpg",
                      "sample_image/sample video 37.jpg"]
        */
        
        /* create list of images to preload. same as above but much less code
        https://medium.com/poka-techblog/simplify-your-javascript-use-map-reduce-and-filter-bd02c593cc2d
        */

        // get the slideshow to display from the url parameters
        const urlParams = new URLSearchParams(window.location.search);
        const filmToShow = urlParams.get("slideshow");

        /*
        const target = 600
        function getScalar(film) {
            switch (film) {
                case "ball-pass":
                    return 540/target;
                case "card-trick":
                    return 720/target;
                case "kidpack":
                    return 281/target;
                case "laces":
                    return 686/target;
                case "practiceslides":
                    return 686/target;
                case "sample-kitchen":
                    return 720/target;
                default:
                    return 1;
            }
        }
        */

        /* set up async GET request */

        var req = new XMLHttpRequest();

        req.open("GET", name_of_xlsx_file, true);
        req.responseType = "arraybuffer";

        var picList;

        var test_stimuli = [];

        req.onload = function(e) {
            var data = new Uint8Array(req.response);
            var workbook = XLSX.read(data, {type:"array"});

            var foundSlideshow = false;
            for (var sheetnum = 0; sheetnum < workbook.SheetNames.length; sheetnum ++) {
                if (filmToShow == workbook.SheetNames[sheetnum]) {
                    foundSlideshow = true;
                }
            }

            // Get worksheet
            var worksheet = workbook.Sheets[filmToShow];

            picList = XLSX.utils.sheet_to_json(worksheet);

            /*
            for (i = 0; i < picList.length; i++) {
                var stim = {stimulus: "./slideshow-directory/" + filmToShow + "/" + picList[i].fileName,
                            stimulus_height: 600,
                            stimulus_width: 100};
                test_stimuli.push(stim);
                
            }

            var images = test_stimuli.map(test_stimuli => test_stimuli.stimulus);

            
            var test = {
                type: "image-keyboard-response",
                stimulus: jsPsych.timelineVariable('stimulus'),
                choices: ['spacebar'],
                data: jsPsych.timelineVariable('data'),
                stimulus_height: 600,
                stimulus_width: 100
            };
            
            var fixation = {
                type: 'html-keyboard-response',
                stimulus: '<div style="font-size:60px;">+</div>',
                choices: jsPsych.NO_KEYS,
                trial_duration: function(){
                    return jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
                },
                data: {test_part: 'fixation'}
            };
            
            var test_procedure = {
                timeline: [test],
                timeline_variables: test_stimuli,
                randomization_order: true,
                repetition: 1,
                stimulus_height: 600,
                stimulus_width: 100
            };

            timeline.push(test_procedure);
            */
            var images = [];
            console.log(picList)

            let excelStimuli = parseWorksheetData(picList, filmToShow);

            for (let j = 0; j < excelStimuli.length; j++) {
                if (excelStimuli[j].is_image) {
                    images.push(excelStimuli[j].stimulus)
                }
                timeline.push(excelStimuli[j]);
            }

            for (let i = 0; i < study_conclusion.length; i ++) {
                timeline.push(parseJavaScriptData(study_conclusion[i]));
            }

            /* finish connection with pavlovia.org */
            var pavlovia_finish = {
                type: "pavlovia",
                command: "finish"
                };
            timeline.push(pavlovia_finish);

            /* start the experiment */
            
            jsPsych.init({
                timeline: timeline,
                preload_images: images,
                on_finish: function(){
                    jsPsych.getDisplayElement().style.fontSize = "30px";
                    jsPsych.getDisplayElement().innerHTML = sessionId;
                    //jsPsych.data.displayData('csv');
                },
            });
        }
    
        req.send();

    </script>
        </body>
    </html>
